--- links-2.22/cookies.c.old	2019-04-07 20:17:57.000000000 +0200
+++ links-2.22/cookies.c	2021-03-20 18:58:47.864668687 +0100
@@ -202,8 +202,28 @@
 
 void free_cookies(void)
 {
+	unsigned char *cookfile;
+	FILE *fp;
+	struct cookie *c; 
+	struct list_head *lc;
 	free_list(struct c_domain, c_domains);
-	/* !!! FIXME: save cookies */
+
+	cookfile = stracpy(links_home);
+	if (! cookfile) return;
+	add_to_strn(&cookfile, "cookies");
+
+	fp = fopen(cookfile, "w");
+	mem_free(cookfile);
+	if (fp == NULL) return;
+
+	foreach (struct cookie, c, lc, all_cookies) {
+		if (c->expires && ! cookie_expired(c))
+			fprintf(fp, "%s %s %s %s %s %d %d\n", c->name, c->value,
+			c->server?c->server:(unsigned char *)"", c->path?c->path:(unsigned char *)"",
+			c->domain?c->domain:(unsigned char *)"", (int)c->expires, c->secure);
+	}
+	fclose(fp);
+
 	while (!list_empty(all_cookies)) {
 		struct cookie *c = list_struct(all_cookies.next, struct cookie);
 		del_from_list(c);
@@ -213,6 +233,68 @@
 
 void init_cookies(void)
 {
-	/* !!! FIXME: read cookies */
-}
+	unsigned char in_buffer[MAX_STR_LEN];
+	unsigned char *cookfile, *p, *q;
+	FILE *fp;
+
+	/* must be called after init_home */
+	if (! links_home) return;
+
+	cookfile = stracpy(links_home);
+	if (! cookfile) return;
+	add_to_strn(&cookfile, "cookies");
+
+	fp = fopen(cookfile, "r");
+	mem_free(cookfile);
+	if (fp == NULL) return;
+
+	while (fgets(in_buffer, MAX_STR_LEN, fp)) {
+		struct cookie *cookie;
+
+		if (!(cookie = mem_alloc(sizeof(struct cookie)))) return;
+		memset(cookie, 0, sizeof(struct cookie));
 
+		q = in_buffer; p = strchr(in_buffer, ' ');
+		if (p == NULL) goto inv;
+		*p++ = '\0';
+		cookie->name = stracpy(q);
+
+		q = p; p = strchr(p, ' ');
+		if (p == NULL) goto inv;
+		*p++ = '\0';
+		cookie->value = stracpy(q);
+
+		q = p; p = strchr(p, ' ');
+		if (p == NULL) goto inv;
+		*p++ = '\0';
+		cookie->server = stracpy(q);
+
+		q = p; p = strchr(p, ' ');
+		if (p == NULL) goto inv;
+		*p++ = '\0';
+		cookie->path = stracpy(q);
+
+		q = p; p = strchr(p, ' ');
+		if (p == NULL) goto inv;
+		*p++ = '\0';
+		cookie->domain = stracpy(q);
+
+		q = p; p = strchr(p, ' ');
+		if (p == NULL) goto inv;
+		*p++ = '\0';
+		cookie->expires = atoi(q);
+
+		cookie->secure = atoi(p);
+
+		/*cookie->id = cookie_id++;*/
+
+		accept_cookie(cookie);
+
+		continue;
+
+inv:
+		free_cookie(cookie);
+		free(cookie);
+	}
+	fclose(fp);
+}
